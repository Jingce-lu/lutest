# 收集的一些兼容问题

[[toc]]

## 1. 遇到 overflow: scroll 不能平滑滚动怎么解决？

iphone 上解决方法是这样的，
`-webkit-overflow-scrolling: touch;`

## 2. 移动端 border 的 1px 问题

构建 1 个伪元素，将它的长宽放大到 2 倍，边框宽度设置为 1px,再以 transform 缩放到 50%

1. 为了方便通用，使用 mixin 定义一个函数。

   ```sass
   @mixin border-1px($color) {
     position: relative;
     &:after{
       display: block;
       position: absolute;
       left: 0;
       bottom: 0;
       width: 100%;
       border-top: 1px solid $color;
       content: ' ';
     }
   }
   ```

2. 对 伪类 :after 进行缩放，以适应不同 dpr 的手机。通过 @media (媒体查询)，来确定 设备的 dpr。 为了方便调用，定义一个全局的 class (此处为 border-1px)

   ```sass
   /* 判断在不同dpr下的显示情况 */
   @media (-webkit-min-device-pixel-ratio: 1.5),(min-device-pixel-ratio: 1.5) {
     .border-1px{
       &::after{
         -webkit-transform: scaleY(0.7);
         transform: scaleY(0.7);
       }
     }
   }

   @media (-webkit-min-device-pixel-ratio: 2),(min-device-pixel-ratio: 2) {
     .border-1px{
       &::after{
         -webkit-transform: scaleY(0.5);
         transform: scaleY(0.5);
       }
     }
   }
   ```

3. html/css 样式调用.

   ```html
   <div class="tab border-1px">
     <div class="tab-item">
       <a v-link="{path:'/goods'}">商品</a>
     </div>
     <div class="tab-item">
       <a v-link="{path:'/ratings'}">评价</a>
     </div>
     <div class="tab-item">
       <a v-link="{path:'/seller'}">商家</a>
     </div>
   </div>
   ```

   ```sass
   .tab{
       display: flex;
       width: 100%;
       height: 40px;
       line-height: 40px;
       @include border-1px(rgba(7,17,27,0.1));
   }
   ```

## 3. 举例说明微信端兼容问题有哪些？

1. 在 ios 微信端，当在输入框唤起键盘后，页面会抬升，输入完成键盘退出后，页面并没有自动恢复到原来的样子, 越接近页面底部越明显。
   解决方法是使用`document.documentElement.scrollIntoView(false)`,让页面自动回滚。
2. 微信自带的下拉出网站信息，苹果自带的滑动回弹，与 fixed 一起，非常非常酸爽
3. 微信视频最好使用全屏模式，否则会有结尾广告、不能被元素覆盖
4. 横屏的项目，微信支付时会竖屏，大部分苹果机支付后无法再横屏了

## 4. 微信小程序的 iPhoneX 适配, 因为 iPhoneX 底部没有虚拟按键，底部的横线会出现遮挡

这时候就要处理下：
大概思路就是获取到客户端设备，然后判断是 iPhoneX 就换样式。  
在 app.js 中添加一个检测当前设备是否是 iPhoneX 的变量：

```js
globalData: {
  userInfo: null,
  isIphoneX: false//判断是否是iPhoneX
},
onShow: function() {
  var that = this;
  wx.getSystemInfo({
    success: function(res) {
      // console.log('手机信息res'+res.model)
      let modelmes = res.model;
      if (modelmes.search('iPhone X') != -1) {
        that.globalData.isIphoneX = true
      }
    },
  })
}
```

在需要做兼容的 xxx.js 中引入：

```js
var app = getApp();
Page({
  data: {
    isIphoneX: false
  },
  onLoad: function() {
    // 判断是否为iPhoneX
    var isIphoneX = app.globalData.isIphoneX;
    console.log(isIphoneX ? "是iPhoneX" : "不是iPhoneX");
    this.setData({
      isIphoneX: isIphoneX
    });
  }
});
```

然后在 xx.wxml 中对需要做兼容的元素做判断 ：

```html
<view class="{{isIphoneX ? 'width30' : 'width10'}}"></view>
```

然后在对应的 wxss 里设置好对应的类名就 ok 了，比较简单方便。

## 5. HTML5 的 video 在有的移动端设备无法自动播放？怎么解决？

避免自动播放浪费流量，手机网页访问带有 audio 的页面不能自动播放。

1. 利用微信的 JSAPI 的创建页面监听 WeixinJSBridgeReady()是实现：
   ```html
   <audio autoplay="autopaly" loop="loop" id="audios">
     <source src="music/bng.mp3" type="audio/mp3" />
   </audio>
   <script
     type="text/javascript"
     src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"
   ></script>
   <script>
     document.addEventListener("WeixinJSBridgeReady", function() {
       document.getElementById("audios").play();
     });
   </script>
   ```
2. 添加控制属性（controls），让用户手动触发
   ```html
   <audio autopaly="autoplay" loop="loop" id="audios" controls="controls">
     <source src=".mp3音乐路径" type="audio/mp3" />
     <audio></audio>
   </audio>
   ```
3. 添加触摸监听，当用户打开浏览出，触摸屏幕事件来监听播放
   ```js
   document.addEventLinstener('touchstart',function{ document.getEmlementById("audios").play() } )
   ```

## 6. 移动端滚动穿透是什么原因？有哪些解决方案？

prevent touch event<br>
直接阻止掉遮罩层和弹窗的 touch event 这样就不会在移动端触发 scroll 事件了。但是在 PC 上没有 touch 事件， scroll 事件仍然可以被触发，原因上面我们也说过，scroll 事件是滚动它能滚动的元素。这里我们解决的是移动端的问题，例子如下：

```html
<div id="app">
  <div class="mask">mask</div>
  <div class="dialog">dialog</div>
</div>
```

```js
const $mask = document.querySelector(".mask");
const $dialog = document.querySelector(".dialog");
const preventTouchMove = $el => {
  $el.addEventListener(
    "touchmove",
    e => {
      e.preventDefault();
    },
    { passive: false }
  );
};
preventTouchMove($mask);
preventTouchMove($dialog);
```

进一步优化<br>
现在的场景是我们的弹窗是可以滚动的，所以不能再直接将其 touch 事件阻止，去掉后我们发现会产生新的问题。遮罩层被阻止了 touch 事件不能使下方滚动，但是弹出层 modal 这里内容是可滚动的，在 touch modal 时能正常滚动里面的内容。但是 modal 滚动到最上方或者最下方时仍然能触发 document 的滚动

我们看到当 modal 滚动在顶部时仍然能拖动下方 document。这样我们只能监听用户手势，如果 modal 已经滑动到了底部或者顶部且还要往上或者下滑动则也要 prevent modal 的 touch 事件。简单实现一个 fuckScrollChaining 函数：

```js
function fuckScrollChaining($mask, $modal) {
  const listenerOpts = { passive: false };
  $mask.addEventListener(
    "touchmove",
    e => {
      e.preventDefault();
    },
    listenerOpts
  );
  const modalHeight = $modal.clientHeight;
  const modalScrollHeight = $modal.scrollHeight;
  let startY = 0;

  $modal.addEventListener("touchstart", e => {
    startY = e.touches[0].pageY;
  });
  $modal.addEventListener(
    "touchmove",
    e => {
      let endY = e.touches[0].pageY;
      let delta = endY - startY;

      if (
        ($modal.scrollTop === 0 && delta > 0) ||
        ($modal.scrollTop + modalHeight === modalScrollHeight && delta < 0)
      ) {
        e.preventDefault();
      }
    },
    listenerOpts
  );
}
```

## 7. 解决键盘弹出后挡表单的问题

```js
window.addEventListener("resize", function() {
  if (
    document.activeElement.tagName === "INPUT" ||
    document.activeElement.tagName === "TEXTAREA" ||
    document.activeElement.getAttribute("contenteditable") == "true"
  ) {
    window.setTimeout(function() {
      if ("scrollIntoView" in document.activeElement) {
        document.activeElement.scrollIntoView();
      } else {
        // @ts-ignore
        document.activeElement.scrollIntoViewIfNeeded();
      }
    }, 0);
  }
});
```

## 8. 如何禁止 IOS 移动端网页橡皮筋的效果？

只需要添加下面的代码即可：

```js
document.body.addEventListener(
  "touchmove",
  function(e) {
    e.preventDefault(); //阻止默认的处理方式(阻止下拉滑动的效果)
  },
  { passive: false }
); //passive 参数不能省略，用来兼容ios和android
```

以 vue 举例。（可以添加监听，也可以解绑啊，目前解决方案只针对了遮罩里没有内部滚动，其他情况还没研究）

```js
document.body.addEventListener('touchmove',this.bodyScroll,{passive: false});
// 实例摧毁解绑 其他页面就可正常滚动
destroyed() {
  document.body.removeEventListener('touchmove',this.bodyScroll,{passive: false});
},
methods: {
  bodyScroll(event) {
    event.preventDefault();
  },
}
```

## 9. CSS 中的 calc()

calc 使得开发者能够使用四则运算表达式来填写 CSS 属性。

px、%、em 等不同单位的数值均可参与计算，浏览器会进行自动转换。

坑： 当使用 calc 的时候，运算符号 左右需要有空格的哦，否则，属性不生效。例如： `width: calc(100% - 30px)`;

在 less 使用中某些情况是无效的`height: calc('100% - 36px');`，
必须要这样才有效 `height: calc(~'100% - 36px');`

## 10.
