# 小程序开发中遇到的坑

[[toc]]

## 1. mpvue 相关

1. 有时候明明设置 一个变量，当它为 false 的时候才展示某个元素，比如 isHide?hide:show，有时候会发现，在页面中，还是会先渲染出来一下，然后才被隐藏了，原因是，最开始的时候，data 数据还没有初始化完成，这个时候，isHide 是 undefined，undefined 变成 boolean 值，就是 false，所以最开始还是 show 了，为了解决这种情况，我们可以使用全等符号。 isHide=== true ?hide:show
2. `scroll-view` 的属性设置，scroll-y 设置，不管我们设置 scroll-y=true 还是 false，其实都会滚动的，要想设置 scroll-y 为 false，我们需要用数据绑定的形式来设置才会起效:scroll-y=false
3. 显示 `image` 的时候，如果我们设置了 `mode=widthFix`，有时候在渲染的时候会看到图片有一个拉伸过程，然后才变成我们期望的大小，解决这个问题，可以给 image 添加 `height:auto`；或者使用 `background-image` 来展示，需要注意的是 `background-image` 不支持本地路径，可以支持本地 base64 或者服务器返回来的图片
4. 在父组件跳转到子组件的时候，使用 `navigateTo` 方法，携带参数，如果参数里面带特殊字符，会被截断，导致我们在子组件获取到的参数不正确。解决办法就是，通过 `encodeURIConponent`，对参数进行编码，然后在子组件再进行解码，其实跟我们 url 传递参数是一样的，都需要注意这一点。
5. cover-view 组件 IOS 可以支持滚动了，不过需要 7.0 以上版本的微信。
6. 单页面目前也是可以支持自定义导航栏，同样需要 7.0 以上版本的微信。
7. mpvue 的坑，双向数据绑定的时候，有些安卓机会卡顿。可以通过防抖赋值或者 v-model.lazy，不使用双向绑定
8. `<cover-view></cover-view>`组件默认不换行，加上这一行代码，可以让它换行 white-space:pre-wrap;

## 2. https 部署以及设置合法域名。

1. 小程序向后台请求接口必须使用 https，包括 web-view 里的网页，如果项目中有用到 web socket，那么也必须使用 wss 协议。https 证书一般会用第三方的。比如阿里云的。
2. 在微信小程序管理后台，还需要配置合法域名。当然，在后台还没有部署 https 之前，我们也可以进行开发调试，只需要设置不校验合法域名，https 证书等即可。

## 3. post 请求，json 数据格式转换

当我们向后台进行 post 请求的时候，当我们的传输数据的格式为 json 的时候，需要设置

> 'content-type': 'application/x-www-form-urlencoded'

## 4. 微信小程序谁是首页的问题

当我们在开发原生应用的时候，我们一般会在程序的入口，设置我们程序的第一个页面，但是反观小程序，并没有找到类似的方法，原来在小程序中，app.json 文件中的 pages 数据的第一个元素，就是首页。但是，我们有时候会有这样的需求，微信扫码直接跳转小程序内部的指定页面，那么，这时，只需要在小程序管理后台，设置扫码打开的页面路径填好即可。

## 5. 微信小程序开发单位问题

我们再开发 iOS 的时候默认使用 `pt`；在开发 Android 的时候，我们使用 `dp`,sp 等单位；在开发 web 的时候使用 em,rem 等单位。但是在我们的小程序里我们只要记住 `rpx` 这一个单位就好了，这样我们开发出来的小程序就完美的运行在各式各样屏幕的手机上了。no!no!no，也是有特殊情况的，有时候我们就不能使用 rpx，比如使用到 `canvas` 的时候，那么就只能使用 px 为单位，那么，如何做到屏幕适配呢？我的做法是使用 `wx.getSystemInfo` 这个 api 来获取到运行手机的屏幕的宽度和高度，那么根据 UI 的标注图的屏幕宽高，就可以换算出一个比例来了。如果大家有更好的做法欢迎交流指正。

## 6. wxss 文件中不支持本地图片

如果我们有一个需求：添加一张背景图，根据 web 开发思维，肯定是在 background-image:中设置本地图片的路径，但是在微信小程序上这是行不通的。微信小程序的 background-image 只支持网络图片。

## 7. this.setData 和直接赋值的区别

这两者都可以造成 data 里数据的改变，但是 this.setData 赋值才会造成 wxml 里面数据的改变，也就是同步更新渲染界面，而直接赋值只会让 data 里数据发生变化，但是界面并不会改变。看代码：

```js
//wxml文件
<text>我的名字是{{name}}</text>

//js文件
//数据源
data: {
    name:'',
  },

onLoad: function (options) {
    this.data.name='张三'//只会使data里数据发送改变，但是界面不会发生改变，界面仍显示”我的名字是“
    console.log(this.data.name)//打印出来的结果是”张三“

    this.setData({
      name: '张三'
    })
    //此时，界面数据才会发生改变，变成”我的名字是张三“
  },
```

## 8. cover-view 组件

这是小程序上特有的组件，它其实是由客户端创建的原生组件。这些组件有：`cavans`，`map`，`vedio` 等，如果想要在原生组件上覆盖组件的话，添加 view,text,button 都是行不通的，必须使用 `cover-view` 和 `cover-image` 组件，具体用法，可以参考微信小程序官方文档。下面我来说说 cover-view 中踩过的坑。cover-view 对 css 支持真的不太友好，虽然我们设置背景色，字体大小，宽高等都没啥问题，但是，

1. 在 web 开发中，如果我们想要给文字设置删除线，那么使用 text-decoration 即可实现，但是抱歉，cover-view 不支持这个属性。
2. 曾经我尝试给 `cover-image` 添加旋转的动画，但是发现怎么都实现不了，我猜测可能也是不支持，后来换了其他方法实现这个需求了。
3. `cover-view` 是有 hidden 属性的，但是我奇葩的发现了，在 ios10 系统上，cover-view 改变 hidden 属性的时候报错了，后来换成了 wx:if，就这样神奇的解决了。
4. 使用 `cover-view` 组件的时候，如果 cover-view 在模拟器上表现是好的，别忘了使用真机跑跑看，说不定会有意想不到的结果哦。
5. 总之，使用 cover-view 的时候一定要小心谨慎。

## 9. 微信小程序不能操作 DOM 树

web 开发中，可以使用 `getElementById()`访问 `documnent` 中的某一个元素，顾名思义，就是通过 id 来获取元素，但是微信小程序没有 `windows` 对象，所以小程序不能直接操作 dom 树，小程序采用的都是 mvvm 的设计模式，数据双向绑定。类似于 vue.js 的写法。

## 10. 微信小程序分享功能如何实现

微信有庞大的流量，既然有这么得天独厚的平台，那么在小程序开发分享功能也是水到渠成的。比如，要开发一个类似外卖平台发红包的功能，照以前开发 app 逻辑，app 客户端负责开发“发红包”的逻辑，集成分享的 sdk，把红包发出去即可，再使用 web 开发“领红包”的逻辑，也就是领红包的页面是一个 web 页面。一开始，我也是打算这么设计这个架构的。但是在 web 页面重新登录，在打开小程序，中间涉及到的登录流程又会显得比较复杂。后来参考了其他小程序的分享功能，把分享页面也定义成一个小程序原生页面，而不是小程序内的 web-view 页面。这样设计，实际开发后，发现其实简单了许多。

## 11. 配置普通链接二维码规则需要注意的地方

这里有一个地方需要注意。开发小程序的时候，我们有一个使用微信扫码打开指定页面的需求。那么我们需要配置一个普通链接二维码规则，但是我们在开发测试的过程中，我们需要来测试我们的跳转功能是否好用。二维码规则需要发布才可以全网使用，测试链接也是只针对管理员开发者体验着等有效果。

<div align="center"><img :src="$withBase('/images/prepare/mobile/2020070601.webp')" alt="prepare/mobile/2020070601.webp"></div>

## 12. 地图导航等功能需要注意的地方

微信小程序集成地图功能非常简单，但是需要注意的是我们使用的是腾讯地图，也就是 `gcj02` 坐标系，如果后台使用的是其他坐标系，那么我们需要转换。如果需要实现导航功能，那么小程序内的 map 组件是没有这个能力的，我们需要调用 `wx.openLocation` 来实现，其实这个 api 是打开了微信内置的腾讯地图，这样，就是我们熟悉的微信导航服务了，可以在这里打开手机内的百度地图，高德地图，腾讯地图这些 app 来进行导航了。

## 13. wx.showToast 吐槽

```js
wx.showToast({
  title: "成功",
  icon: "success",
  duration: 2000
});
```

微信提供的这个 api，默认的提示图标是一个小勾勾，但是即使不设置 icon，也会出现这个图标，这就很难受了。如果我想提示失败呢？你给我一个对勾的图标？我的解决办法就是自己写了一个 toast-view

## 14. 添加点击事件

在 wxml 文件中，text,image,view,button 等标签都可以添加点击事件。（ps:这点比移动开发中只有 button 才能添加点击事件，其他的只能添加手势方便了许多）使用 button 的时候有一点需要注意，那就是 button 有默认的样式，我们如果不需要这个样式，需要手动清除。

## 15. 微信小程序 app.json 里 pages 数组中路径顺序问题

这个坑有点深，之前没注意，后来加了底部的 tabBar 才发现，原来这个顺序和底部的 tabBar 有很大关系。配置 tabBar 时，list 参数中的 pagePath 参数至少需要包含 app.json 里 pages 数组中的第一个路径，否则会导致 tabBar 不显示。

## 16. 微信小程序底部菜单 tabBar 跳转无法带参数问题

开发微信小程序的都会碰到过，就是小程序底部菜单跳转的时候，是不能带参数的，这个问题也很好解决，直接把需要传递参数的页面在跳转前将数据添加到全局数据 app.js 里。需要接受参数的页面在 onShow 方法接收之前，添加到 app.js 的数据就可以了

## 17. 微信小程序使用 POST 方法请求的问题

这个坑也是不小的坑，微信小程序发起 `wx.request()`方法请求，用 get 方法请求都没什么问题，但是用 post 方法请求时，就容易出现这样或那样的问题，原因是 `wx.request()`使用 post 方法请求时，还需要加上 header，`header[content-type]`值为 `application/x-www-form-urlencoded`，否则请求返回失败。

## 18. 微信小程序标签层级问题。

做项目时，我们时常遇到标签层级问题，会惯性设置 z-index 的值，但是在微信小程序中有几个原生组件，如 textarea、canvas、map、video，其层级位于 webview 之上。也就是你给 view、text 等等非原生组件无论设置多大的 z-index 值都不行。

可行的解决方式：

1. 使用 cover-view，它能覆盖在原生组件之上，但是有限制，cover-view 只可嵌套 cover-view、cover-image、button。
2. 可在需要时，进行隐藏掉，对于 canvas 图可转为图片形式。

## 19. iphone 手机：new Date()的坑

解决：在 iphone 手机中，不能使用 new Date 处理"2020-01-01 12:12"格式的时间，而是要“2020/01/01 12:12”这种格式的才行，所以，我们可以使用正则表达式，把‘-’改为‘/’。具体如下

```js
var date = "2020-01-01 12:12";
date = new Date(date.replace(/-/g, "/"));
```

## 20. text、view 中文/英文不自动换行问题

加如下 3 行样式即可。

```css
text,
view {
  word-wrap: break-word;
  word-break: break-all;
  white-space: pre-line;
}
```

## 21. 第三方组件样式修改

以 iview webapp 为例，不能直接通过其 class 的类名直接修改组件样式，可通过 i-class 来给组件添加类名，通过 i-class 来修改样式。

```vue
<i-page
  i-class="ipage"
  current="{{ page }}"
  total="{{ total }}"
  bind:change="handleChange"
>
   <view slot="prev">
        <i-icon type="return"></i-icon>
          上一页
       </view>
       <view slot="next">
          下一页
       <i-icon type="enter"></i-icon>
   </view>
</i-page>

<style>
.ipage {
  height: 64px !important;
}
</style>
```

## 22. wxml 标签

wxml 的标签跟 html 里面的一些标签是一样的，就说 view 标签就相当于 div 标签，text 标签相当于 span 标签吧，然就是表单元素，这里就要注意了，在微信小程序中，表单元素都是原生组件，微信小程序中原生组件层级最高，所以在用 input，canvas，map 这些组件就要注意了。其中在样式上不支持 overflow-x/overflow-y，只可使用 overflow。

在 input 标签中会出现 placeholder 文字位置不固定，可使用使用 placeholder-class 属性修改 placeholder 样式。input 标签无法设置 font-family; 。对 input 直接 float：left 也是不行的，要在 input 外面套 view，然后对其进行浮动。

scroll-view 组件注意事项：

1. 不要在 scroll-view 中使用 textarea、map、canvas、video 组件
2. scroll-into-view 的优先级高于 scroll-top。
3. 在滚动 scroll-view 时会阻止页面回弹，所以在 scroll-view 中滚动，是无法触发 onPullDownRefresh。

在 map 组件中只能使用 cover-view 标签，在 cover-view 标签下只能使用 cover-view 以及 cover-image 标签，这两种标签在样式上的问题非常多，不建议使用，问题

1. 当使用 display:none;做隐藏的时候，其内容文字会出现在屏幕右上角，建议使用 wx:if="false"或 position:absolute;left:-1000rpx;这种方式做隐藏。
2. border 不支持单边。
3. 不支持 padding 的使用，在安卓端会出现 padding 消失的问题。

## 23. 动画问题

在小程序中当有两个元素同时发生变化时，会出现冲突，导致其中一个变化，而另一个不做变化，所以要使用 setTimeout 方法避免元素同时出现变化。

## 24.

## 25.

## 26.

## 27.

## 28.

## 29.

## 30.
